<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breath Master</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: white;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .floating-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) translateX(0px); opacity: 0.3; }
            50% { transform: translateY(-20px) translateX(10px); opacity: 1; }
        }

        .main-content {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
        }

        .app-title {
            font-size: 3.5rem;
            font-weight: 300;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #fff, #87ceeb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3)); }
            to { filter: drop-shadow(0 0 30px rgba(135, 206, 235, 0.5)); }
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #87ceeb;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 2rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .mode-card:hover::before {
            left: 100%;
        }

        .mode-card:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .mode-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .mode-description {
            font-size: 0.9rem;
            opacity: 0.8;
            line-height: 1.4;
        }

        .exercise-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .breathing-circle {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(135, 206, 235, 0.3), rgba(255, 255, 255, 0.1));
            border: 3px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .breathing-circle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.3s ease;
        }

        .breathing-circle.inhale {
            transform: scale(1.3);
        }

        .breathing-circle.inhale::before {
            transform: translate(-50%, -50%) scale(1);
        }

        .breathing-circle.hold {
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4), rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 215, 0, 0.6);
        }

        .breathing-circle.exhale {
            transform: scale(0.7);
            background: radial-gradient(circle, rgba(100, 149, 237, 0.4), rgba(255, 255, 255, 0.1));
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 300;
            margin: 1rem 0;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .instruction-text {
            font-size: 1.5rem;
            margin: 1rem 0;
            opacity: 0.9;
            min-height: 2rem;
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #87ceeb, #fff);
            border-radius: 4px;
            transition: width 0.1s ease;
            width: 0%;
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #87ceeb, #4682b4);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            z-index: 1000;
            transition: transform 0.3s ease;
            border: 2px solid #ffd700;
        }

        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .achievement-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .level-indicator {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .back-btn {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .creator-credit {
            font-size: 1rem;
            opacity: 0.7;
            margin-bottom: 2rem;
            font-style: italic;
        }

        .settings-panel {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .reset-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .warning-dialog {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            border-radius: 20px;
            padding: 2.5rem;
            text-align: center;
            max-width: 500px;
            margin: 0 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .warning-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .warning-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: white;
        }

        .warning-text {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.9);
        }

        .warning-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-confirm {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .btn-confirm:hover {
            background: white;
            color: #ff4757;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.9);
            color: #ff4757;
            border: 2px solid white;
        }

        .btn-cancel:hover {
            background: white;
        }

        .progress-data {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            font-size: 1.1rem;
        }

        .data-export {
            margin-top: 1rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 2.5rem;
            }
            
            .breathing-circle {
                width: 250px;
                height: 250px;
            }
            
            .timer-display {
                font-size: 3rem;
            }

            .warning-dialog {
                margin: 1rem;
                padding: 2rem;
            }

            .warning-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="floating-particles" id="particles"></div>
    
    <div class="app-container">
        <div class="main-content" id="mainMenu">
            <h1 class="app-title">BREATH MASTER</h1>
            <div class="creator-credit">Created by Amit</div>
            
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-value" id="maxHoldTime">0s</div>
                    <div class="stat-label">Max Hold Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="currentLevel">1</div>
                    <div class="stat-label">Current Level</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">Sessions Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="streakDays">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>

            <div class="mode-selector">
                <div class="mode-card" onclick="startMode('test')">
                    <div class="mode-icon">🫁</div>
                    <div class="mode-title">Breath Hold Test</div>
                    <div class="mode-description">Discover your maximum breath holding capacity</div>
                </div>
                
                <div class="mode-card" onclick="startMode('box')">
                    <div class="mode-icon">📦</div>
                    <div class="mode-title">Box Breathing</div>
                    <div class="mode-description">4-4-4-4 pattern for stress relief and focus</div>
                </div>
                
                <div class="mode-card" onclick="startMode('wim')">
                    <div class="mode-icon">❄️</div>
                    <div class="mode-title">Wim Hof Method</div>
                    <div class="mode-description">Advanced breathing for extended breath holds</div>
                </div>
                
                <div class="mode-card" onclick="startMode('triangle')">
                    <div class="mode-icon">🔺</div>
                    <div class="mode-title">Triangle Breathing</div>
                    <div class="mode-description">4-4-4 pattern for balance and relaxation</div>
                </div>
                
                <div class="mode-card" onclick="startMode('progressive')">
                    <div class="mode-icon">📈</div>
                    <div class="mode-title">Progressive Training</div>
                    <div class="mode-description">Gradually increase your breath holding time</div>
                </div>
                
                <div class="mode-card" onclick="startMode('endurance')">
                    <div class="mode-icon">💪</div>
                    <div class="mode-title">Endurance Challenge</div>
                    <div class="mode-description">Push your limits with timed challenges</div>
                </div>
            </div>

            <div class="settings-panel">
                <button class="btn btn-secondary" onclick="showModeInfo()">📖 Learn About Modes</button>
                <button class="btn btn-danger" onclick="showResetWarning()">⚠️ Reset All Progress</button>
            </div>
        </div>

        <div class="exercise-screen" id="exerciseScreen">
            <button class="back-btn" onclick="goBackToMenu()">← Back</button>
            
            <div class="level-indicator">
                <div>Level <span id="exerciseLevel">1</span></div>
                <div>XP: <span id="currentXP">0</span>/<span id="nextLevelXP">100</span></div>
            </div>

            <div class="breathing-circle" id="breathingCircle">
                <div class="timer-display" id="timerDisplay">0</div>
            </div>
            
            <div class="instruction-text" id="instructionText">Get ready...</div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-primary" id="startBtn" onclick="startExercise()">Start</button>
                <button class="btn btn-secondary" id="pauseBtn" onclick="pauseExercise()" style="display: none;">Pause</button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopExercise()" style="display: none;">Stop</button>
            </div>
        </div>
    </div>

    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon">🏆</div>
        <div id="achievementText">Achievement Unlocked!</div>
        <button class="btn btn-primary" onclick="closeAchievement()">Continue</button>
    </div>

    <!-- Reset Warning Dialog -->
    <div class="reset-warning" id="resetWarning">
        <div class="warning-dialog">
            <div class="warning-icon">⚠️</div>
            <div class="warning-title" id="warningTitle">Reset All Progress?</div>
            <div class="warning-text" id="warningText">
                This will permanently delete all your breathing training data, including your personal records, level progress, and statistics. This action cannot be undone.
            </div>
            <div class="progress-data" id="progressData">
                <div class="progress-item">
                    <span>Max Hold Time:</span>
                    <span id="confirmMaxHold">0s</span>
                </div>
                <div class="progress-item">
                    <span>Current Level:</span>
                    <span id="confirmLevel">1</span>
                </div>
                <div class="progress-item">
                    <span>Total Sessions:</span>
                    <span id="confirmSessions">0</span>
                </div>
                <div class="progress-item">
                    <span>Current XP:</span>
                    <span id="confirmXP">0</span>
                </div>
            </div>
            <div class="warning-buttons">
                <button class="btn btn-cancel" onclick="cancelReset()">Cancel</button>
                <button class="btn btn-confirm" id="confirmBtn" onclick="confirmReset()">I understand, delete everything</button>
            </div>
        </div>
    </div>

    <!-- Mode Information Dialog -->
    <div class="reset-warning" id="modeInfo">
        <div class="warning-dialog" style="background: linear-gradient(135deg, #667eea, #764ba2); max-width: 700px;">
            <div class="warning-icon">📚</div>
            <div class="warning-title">Breathing Exercise Modes</div>
            <div class="mode-info-content">
                <div class="mode-detail">
                    <h3>🫁 Breath Hold Test</h3>
                    <p>Discover your maximum breath holding capacity. This baseline test helps you understand your current lung capacity and sets a benchmark for improvement. Start here to establish your personal record.</p>
                </div>
                
                <div class="mode-detail">
                    <h3>📦 Box Breathing</h3>
                    <p>A powerful 4-4-4-4 second pattern (inhale-hold-exhale-hold) used by Navy SEALs and elite athletes. Perfect for stress relief, anxiety reduction, and improving focus. Excellent for beginners and daily practice.</p>
                </div>
                
                <div class="mode-detail">
                    <h3>❄️ Wim Hof Method</h3>
                    <p>Advanced technique involving 30 rapid, deep breaths followed by an extended breath hold. Based on the methods of "The Iceman" Wim Hof, this practice can increase oxygen efficiency and cold tolerance.</p>
                </div>
                
                <div class="mode-detail">
                    <h3>🔺 Triangle Breathing</h3>
                    <p>A balanced 4-4-4 second pattern (inhale-hold-exhale) that promotes equilibrium and relaxation. Great for meditation preparation and achieving mental balance throughout the day.</p>
                </div>
                
                <div class="mode-detail">
                    <h3>📈 Progressive Training</h3>
                    <p>Systematically increases breath hold duration across multiple rounds (15s, 20s, 25s). Perfect for gradually building lung capacity and breath control without overwhelming your system.</p>
                </div>
                
                <div class="mode-detail">
                    <h3>💪 Endurance Challenge</h3>
                    <p>Push your limits with extended 2-minute breath holds. Designed for advanced practitioners who want to test their maximum capacity and build serious breath endurance.</p>
                </div>
            </div>
            <div class="warning-buttons">
                <button class="btn btn-primary" onclick="closeModeInfo()">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            maxHoldTime: parseInt(localStorage.getItem('maxHoldTime')) || 0,
            currentLevel: parseInt(localStorage.getItem('currentLevel')) || 1,
            totalSessions: parseInt(localStorage.getItem('totalSessions')) || 0,
            streakDays: parseInt(localStorage.getItem('streakDays')) || 0,
            currentXP: parseInt(localStorage.getItem('currentXP')) || 0,
            lastPlayDate: localStorage.getItem('lastPlayDate') || null,
            sessionHistory: JSON.parse(localStorage.getItem('sessionHistory')) || [],
            achievements: JSON.parse(localStorage.getItem('achievements')) || [],
            personalRecords: JSON.parse(localStorage.getItem('personalRecords')) || {
                boxBreathing: 0,
                wimHof: 0,
                triangle: 0,
                progressive: 0,
                endurance: 0
            },
            currentMode: null,
            isRunning: false,
            isPaused: false,
            currentTime: 0,
            targetTime: 0,
            phaseIndex: 0,
            phases: [],
            resetWarningStep: 0
        };

        // Exercise patterns
        const exercisePatterns = {
            test: {
                name: "Breath Hold Test",
                phases: [
                    { type: 'prepare', duration: 5, instruction: 'Prepare yourself...' },
                    { type: 'inhale', duration: 4, instruction: 'Take a deep breath in' },
                    { type: 'hold', duration: 300, instruction: 'Hold your breath! Click stop when you need to breathe' }
                ]
            },
            box: {
                name: "Box Breathing",
                phases: [
                    { type: 'inhale', duration: 4, instruction: 'Breathe in' },
                    { type: 'hold', duration: 4, instruction: 'Hold' },
                    { type: 'exhale', duration: 4, instruction: 'Breathe out' },
                    { type: 'hold', duration: 4, instruction: 'Hold' }
                ],
                cycles: 8
            },
            wim: {
                name: "Wim Hof Method",
                phases: [
                    { type: 'inhale', duration: 2, instruction: 'Deep breath in' },
                    { type: 'exhale', duration: 1, instruction: 'Let go' }
                ],
                cycles: 30,
                finalHold: true
            },
            triangle: {
                name: "Triangle Breathing",
                phases: [
                    { type: 'inhale', duration: 4, instruction: 'Breathe in' },
                    { type: 'hold', duration: 4, instruction: 'Hold' },
                    { type: 'exhale', duration: 4, instruction: 'Breathe out' }
                ],
                cycles: 10
            },
            progressive: {
                name: "Progressive Training",
                phases: [
                    { type: 'inhale', duration: 4, instruction: 'Deep breath in' },
                    { type: 'hold', duration: 15, instruction: 'Hold - Round 1' },
                    { type: 'exhale', duration: 4, instruction: 'Breathe out' },
                    { type: 'rest', duration: 10, instruction: 'Rest and prepare' },
                    { type: 'inhale', duration: 4, instruction: 'Deep breath in' },
                    { type: 'hold', duration: 20, instruction: 'Hold - Round 2' },
                    { type: 'exhale', duration: 4, instruction: 'Breathe out' },
                    { type: 'rest', duration: 10, instruction: 'Rest and prepare' },
                    { type: 'inhale', duration: 4, instruction: 'Deep breath in' },
                    { type: 'hold', duration: 25, instruction: 'Hold - Round 3' }
                ]
            },
            endurance: {
                name: "Endurance Challenge",
                phases: [
                    { type: 'prepare', duration: 10, instruction: 'Prepare for the challenge...' },
                    { type: 'inhale', duration: 5, instruction: 'Take the deepest breath you can' },
                    { type: 'hold', duration: 120, instruction: 'Endurance hold - push your limits!' }
                ]
            }
        };

        // Initialize app
        function init() {
            createParticles();
            updateStats();
            updateUI();
        }

        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                container.appendChild(particle);
            }
        }

        function updateStats() {
            document.getElementById('maxHoldTime').textContent = gameState.maxHoldTime + 's';
            document.getElementById('currentLevel').textContent = gameState.currentLevel;
            document.getElementById('totalSessions').textContent = gameState.totalSessions;
            document.getElementById('streakDays').textContent = gameState.streakDays;
            document.getElementById('exerciseLevel').textContent = gameState.currentLevel;
            document.getElementById('currentXP').textContent = gameState.currentXP;
            document.getElementById('nextLevelXP').textContent = gameState.currentLevel * 100;
        }

        function updateUI() {
            // Update level-based UI elements
            const levelProgress = (gameState.currentXP / (gameState.currentLevel * 100)) * 100;
            // Could add level progress bar here
        }

        function saveProgress() {
            // Update streak
            const today = new Date().toDateString();
            if (gameState.lastPlayDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (gameState.lastPlayDate === yesterday.toDateString()) {
                    gameState.streakDays++;
                } else if (gameState.lastPlayDate !== null) {
                    gameState.streakDays = 1;
                }
                gameState.lastPlayDate = today;
            }

            // Save all data to localStorage
            const dataToSave = [
                'maxHoldTime', 'currentLevel', 'totalSessions', 'streakDays', 
                'currentXP', 'lastPlayDate'
            ];
            
            dataToSave.forEach(key => {
                if (typeof gameState[key] === 'number' || typeof gameState[key] === 'string') {
                    localStorage.setItem(key, gameState[key].toString());
                }
            });

            // Save complex data as JSON
            localStorage.setItem('sessionHistory', JSON.stringify(gameState.sessionHistory));
            localStorage.setItem('achievements', JSON.stringify(gameState.achievements));
            localStorage.setItem('personalRecords', JSON.stringify(gameState.personalRecords));
        }

        function startMode(mode) {
            gameState.currentMode = mode;
            gameState.phases = [...exercisePatterns[mode].phases];
            gameState.phaseIndex = 0;
            gameState.currentTime = 0;
            gameState.isRunning = false;
            gameState.isPaused = false;

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('exerciseScreen').style.display = 'flex';
            
            document.getElementById('instructionText').textContent = 'Ready to begin ' + exercisePatterns[mode].name + '?';
            document.getElementById('timerDisplay').textContent = '0';
            document.getElementById('progressFill').style.width = '0%';
            
            resetCircle();
        }

        function goBackToMenu() {
            stopExercise();
            document.getElementById('exerciseScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
        }

        function startExercise() {
            if (gameState.isPaused) {
                gameState.isPaused = false;
                document.getElementById('pauseBtn').style.display = 'inline-block';
                document.getElementById('startBtn').style.display = 'none';
                continueTimer();
                return;
            }

            gameState.isRunning = true;
            gameState.phaseIndex = 0;
            gameState.currentTime = 0;
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            nextPhase();
        }

        function pauseExercise() {
            gameState.isPaused = true;
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            clearInterval(gameState.timer);
        }

        function stopExercise() {
            gameState.isRunning = false;
            gameState.isPaused = false;
            clearInterval(gameState.timer);
            
            // Record session data
            const sessionData = {
                mode: gameState.currentMode,
                duration: gameState.currentTime,
                date: new Date().toISOString(),
                completed: true
            };
            gameState.sessionHistory.push(sessionData);
            
            // Check for personal records and achievements
            if (gameState.currentMode === 'test' && gameState.currentTime > gameState.maxHoldTime) {
                gameState.maxHoldTime = gameState.currentTime;
                showAchievement('New Personal Record!', '🎉 ' + gameState.currentTime + ' seconds!');
                
                // Check milestone achievements
                checkBreathHoldAchievements(gameState.currentTime);
            }

            // Update mode-specific records
            if (gameState.personalRecords[gameState.currentMode] !== undefined) {
                if (gameState.currentTime > gameState.personalRecords[gameState.currentMode]) {
                    gameState.personalRecords[gameState.currentMode] = gameState.currentTime;
                    showAchievement('Mode Record!', '🏆 New ' + exercisePatterns[gameState.currentMode].name + ' record!');
                }
            }
            
            gameState.totalSessions++;
            gameState.currentXP += Math.max(25, Math.floor(gameState.currentTime / 2));
            
            checkLevelUp();
            checkSessionAchievements();
            saveProgress();
            updateStats();
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('instructionText').textContent = 'Exercise completed! Great job!';
            
            resetCircle();
        }

        function nextPhase() {
            if (gameState.phaseIndex >= gameState.phases.length) {
                // Check if we need to cycle (for repeating exercises)
                const pattern = exercisePatterns[gameState.currentMode];
                if (pattern.cycles && gameState.cycleCount < pattern.cycles) {
                    gameState.phaseIndex = 0;
                    gameState.cycleCount = (gameState.cycleCount || 0) + 1;
                } else if (pattern.finalHold && !gameState.finalHoldDone) {
                    // Add final hold phase for Wim Hof
                    gameState.phases.push({ 
                        type: 'hold', 
                        duration: 120, 
                        instruction: 'Final hold - hold as long as you can!' 
                    });
                    gameState.finalHoldDone = true;
                } else {
                    stopExercise();
                    return;
                }
            }

            const currentPhase = gameState.phases[gameState.phaseIndex];
            gameState.targetTime = currentPhase.duration;
            gameState.currentTime = 0;
            
            document.getElementById('instructionText').textContent = currentPhase.instruction;
            updateCircleState(currentPhase.type);
            
            startTimer();
        }

        function startTimer() {
            clearInterval(gameState.timer);
            gameState.timer = setInterval(() => {
                if (!gameState.isPaused) {
                    gameState.currentTime++;
                    updateDisplay();
                    
                    if (gameState.currentTime >= gameState.targetTime) {
                        gameState.phaseIndex++;
                        nextPhase();
                    }
                }
            }, 1000);
        }

        function continueTimer() {
            startTimer();
        }

        function updateDisplay() {
            document.getElementById('timerDisplay').textContent = gameState.currentTime;
            
            const progress = (gameState.currentTime / gameState.targetTime) * 100;
            document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
        }

        function updateCircleState(type) {
            const circle = document.getElementById('breathingCircle');
            circle.className = 'breathing-circle ' + type;
        }

        function resetCircle() {
            const circle = document.getElementById('breathingCircle');
            circle.className = 'breathing-circle';
        }

        function checkLevelUp() {
            const requiredXP = gameState.currentLevel * 100;
            if (gameState.currentXP >= requiredXP) {
                gameState.currentLevel++;
                gameState.currentXP = gameState.currentXP - requiredXP;
                showAchievement('Level Up!', '🎖️ You reached level ' + gameState.currentLevel + '!');
            }
        }

        function showAchievement(title, message) {
            document.getElementById('achievementText').innerHTML = '<h3>' + title + '</h3><p>' + message + '</p>';
            document.getElementById('achievementPopup').classList.add('show');
        }

        function closeAchievement() {
            document.getElementById('achievementPopup').classList.remove('show');
        }

        function checkBreathHoldAchievements(time) {
            const milestones = [
                { time: 30, title: 'First Breath', message: '30 seconds - You\'re getting started!' },
                { time: 60, title: 'Minute Master', message: '1 minute - Solid foundation!' },
                { time: 90, title: 'Extended Hold', message: '90 seconds - Impressive control!' },
                { time: 120, title: 'Two Minute Club', message: '2 minutes - Elite level!' },
                { time: 180, title: 'Breath Master', message: '3 minutes - Extraordinary!' }
            ];

            milestones.forEach(milestone => {
                const achievementKey = 'breathHold_' + milestone.time;
                if (time >= milestone.time && !gameState.achievements.includes(achievementKey)) {
                    gameState.achievements.push(achievementKey);
                    showAchievement(milestone.title, milestone.message);
                }
            });
        }

        function checkSessionAchievements() {
            const sessionMilestones = [
                { count: 5, title: 'Getting Started', message: '5 sessions completed!' },
                { count: 25, title: 'Dedicated Student', message: '25 sessions - Building habits!' },
                { count: 50, title: 'Breathing Warrior', message: '50 sessions - True dedication!' },
                { count: 100, title: 'Breath Legend', message: '100 sessions - Legendary commitment!' }
            ];

            sessionMilestones.forEach(milestone => {
                const achievementKey = 'sessions_' + milestone.count;
                if (gameState.totalSessions >= milestone.count && !gameState.achievements.includes(achievementKey)) {
                    gameState.achievements.push(achievementKey);
                    showAchievement(milestone.title, milestone.message);
                }
            });
        }

        function showResetWarning() {
            gameState.resetWarningStep = 1;
            updateResetDialog();
            document.getElementById('resetWarning').style.display = 'flex';
        }

        function updateResetDialog() {
            const titles = [
                'Reset All Progress?',
                'Are you absolutely sure?',
                'This is your final warning!'
            ];
            
            const messages = [
                'This will permanently delete all your breathing training data, including your personal records, level progress, and statistics. This action cannot be undone.',
                'You will lose ALL of your achievements, personal records, and training history. Your current level and XP will be reset to zero.',
                'Last chance! Once you click confirm, everything will be permanently deleted. There is no way to recover your data.'
            ];

            const step = gameState.resetWarningStep - 1;
            document.getElementById('warningTitle').textContent = titles[step];
            document.getElementById('warningText').textContent = messages[step];
            
            // Update progress data display
            document.getElementById('confirmMaxHold').textContent = gameState.maxHoldTime + 's';
            document.getElementById('confirmLevel').textContent = gameState.currentLevel;
            document.getElementById('confirmSessions').textContent = gameState.totalSessions;
            document.getElementById('confirmXP').textContent = gameState.currentXP;
            
            // Update button text based on step
            const confirmBtn = document.getElementById('confirmBtn');
            const buttonTexts = [
                'I understand, delete everything',
                'Yes, I really want to reset',
                'CONFIRM: Delete all my data'
            ];
            confirmBtn.textContent = buttonTexts[step];
            
            // Change colors for final warning
            if (gameState.resetWarningStep === 3) {
                confirmBtn.style.background = 'rgba(255, 0, 0, 0.8)';
                confirmBtn.style.borderColor = '#ff0000';
            }
        }

        function confirmReset() {
            if (gameState.resetWarningStep < 3) {
                gameState.resetWarningStep++;
                updateResetDialog();
                return;
            }

            // Final step - actually reset everything
            localStorage.clear();
            
            // Reset game state to defaults
            gameState = {
                maxHoldTime: 0,
                currentLevel: 1,
                totalSessions: 0,
                streakDays: 0,
                currentXP: 0,
                lastPlayDate: null,
                sessionHistory: [],
                achievements: [],
                personalRecords: {
                    boxBreathing: 0,
                    wimHof: 0,
                    triangle: 0,
                    progressive: 0,
                    endurance: 0
                },
                currentMode: null,
                isRunning: false,
                isPaused: false,
                currentTime: 0,
                targetTime: 0,
                phaseIndex: 0,
                phases: [],
                resetWarningStep: 0
            };
            
            updateStats();
            document.getElementById('resetWarning').style.display = 'none';
            showAchievement('Progress Reset', '🔄 All data has been cleared. Start your journey again!');
        }

        function cancelReset() {
            gameState.resetWarningStep = 0;
            document.getElementById('resetWarning').style.display = 'none';
        }

        function showModeInfo() {
            document.getElementById('modeInfo').style.display = 'flex';
        }

        function closeModeInfo() {
            document.getElementById('modeInfo').style.display = 'none';
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
